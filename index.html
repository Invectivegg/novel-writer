<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novel Writer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: #2a2a2a;
            padding: 1rem;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #60a5fa;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            background: #404040;
            border: none;
            color: #e0e0e0;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .nav-tab.active {
            background: #60a5fa;
            color: #1a1a1a;
        }

        .nav-tab:hover {
            background: #505050;
        }

        .nav-tab.active:hover {
            background: #60a5fa;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Characters Tab */
        .characters-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .characters-header {
            padding: 1rem;
            background: #2a2a2a;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-btn {
            background: #22c55e;
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .characters-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .character-card {
            background: #2a2a2a;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #404040;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .character-card:hover {
            border-color: #60a5fa;
        }

        .character-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 0.5rem;
        }

        .character-traits {
            font-size: 0.9rem;
            color: #a0a0a0;
            line-height: 1.4;
        }

        /* Plot Tab */
        .plot-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .plot-header {
            padding: 1rem;
            background: #2a2a2a;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .plot-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .plot-point {
            background: #2a2a2a;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #404040;
            cursor: pointer;
        }

        .plot-point.major {
            border-left: 4px solid #60a5fa;
        }

        .plot-point.minor {
            margin-left: 1rem;
            border-left: 4px solid #a0a0a0;
        }

        .plot-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .plot-description {
            font-size: 0.9rem;
            color: #a0a0a0;
            line-height: 1.4;
        }

        /* Writing Tab */
        .writing-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .writing-header {
            padding: 1rem;
            background: #2a2a2a;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chapter-select {
            background: #404040;
            border: 1px solid #606060;
            color: #e0e0e0;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }

        .writing-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .writing-panes {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .plot-draft-pane {
            width: 40%;
            background: #2a2a2a;
            border-right: 1px solid #404040;
            display: flex;
            flex-direction: column;
        }

        .plot-draft-header {
            padding: 0.5rem 1rem;
            background: #333;
            border-bottom: 1px solid #404040;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .plot-draft {
            flex: 1;
            background: #2a2a2a;
            border: none;
            color: #e0e0e0;
            padding: 1rem;
            font-family: inherit;
            font-size: 0.9rem;
            resize: none;
            outline: none;
        }

        .writing-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .writing-area {
            flex: 1;
            background: #1a1a1a;
            border: none;
            color: #e0e0e0;
            padding: 1rem;
            font-family: 'Georgia', serif;
            font-size: 1rem;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        .notes-panel {
            position: absolute;
            right: 0;
            top: 0;
            width: 300px;
            background: #2a2a2a;
            border-left: 1px solid #404040;
            padding: 1rem;
            display: none;
            z-index: 10;
            max-height: 100%;
            overflow-y: auto;
        }

        .notes-panel.active {
            display: block;
        }

        .character-link {
            text-decoration: underline;
            color: #60a5fa;
            cursor: pointer;
        }

        .annotated-text {
            background: rgba(96, 165, 250, 0.2);
            text-decoration: underline;
            cursor: pointer;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #2a2a2a;
            border-radius: 0.5rem;
            padding: 2rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #ef4444;
            border: none;
            color: white;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #60a5fa;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            background: #404040;
            border: 1px solid #606060;
            color: #e0e0e0;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .save-btn {
            background: #22c55e;
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }

        .character-popup {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 0.5rem;
            padding: 1rem;
            max-width: 300px;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .character-popup.active {
            display: block;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .writing-panes {
                flex-direction: column;
            }

            .plot-draft-pane {
                width: 100%;
                height: 30%;
                border-right: none;
                border-bottom: 1px solid #404040;
            }

            .notes-panel {
                width: 100%;
                position: relative;
                border-left: none;
                border-top: 1px solid #404040;
            }

            .nav-tabs {
                flex-wrap: wrap;
                gap: 0.25rem;
            }

            .nav-tab {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .modal-content {
                margin: 1rem;
                max-width: calc(100% - 2rem);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>Novel Writer</h1>
            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="characters">Characters</button>
                <button class="nav-tab" data-tab="plot">Plot</button>
                <button class="nav-tab" data-tab="writing">Write</button>
            </nav>
        </header>

        <main class="main-content">
            <!-- Characters Tab -->
            <div class="tab-content active" id="characters-tab">
                <div class="characters-container">
                    <div class="characters-header">
                        <h2>Characters</h2>
                        <button class="add-btn" onclick="openCharacterModal()">Add Character</button>
                    </div>
                    <div class="characters-list" id="characters-list">
                        <!-- Characters will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Plot Tab -->
            <div class="tab-content" id="plot-tab">
                <div class="plot-container">
                    <div class="plot-header">
                        <h2>Plot Structure</h2>
                        <button class="add-btn" onclick="openPlotModal()">Add Plot Point</button>
                    </div>
                    <div class="plot-list" id="plot-list">
                        <!-- Plot points will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Writing Tab -->
            <div class="tab-content" id="writing-tab">
                <div class="writing-container">
                    <div class="writing-header">
                        <h2>Writing</h2>
                        <select class="chapter-select" id="chapter-select">
                            <option value="1">Chapter 1</option>
                            <option value="2">Chapter 2</option>
                            <option value="3">Chapter 3</option>
                            <option value="4">Chapter 4</option>
                            <option value="5">Chapter 5</option>
                        </select>
                    </div>
                    <div class="writing-main">
                        <div class="writing-panes">
                            <div class="plot-draft-pane">
                                <div class="plot-draft-header">Chapter Plot Draft</div>
                                <textarea class="plot-draft" id="plot-draft" placeholder="Outline your chapter plot here..."></textarea>
                            </div>
                            <div class="writing-pane">
                                <textarea class="writing-area" id="writing-area" placeholder="Start writing your story here..."></textarea>
                                <div class="notes-panel" id="notes-panel">
                                    <h3>Notes</h3>
                                    <div id="note-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Character Modal -->
    <div class="modal" id="character-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('character-modal')">&times;</button>
            <h2 id="character-modal-title">Add Character</h2>
            <form id="character-form">
                <div class="form-group">
                    <label for="char-name">Name</label>
                    <input type="text" id="char-name" required>
                </div>
                <div class="form-group">
                    <label for="char-traits">Traits</label>
                    <textarea id="char-traits" placeholder="Physical and personality traits..."></textarea>
                </div>
                <div class="form-group">
                    <label for="char-visuals">Visual Description</label>
                    <textarea id="char-visuals" placeholder="How they look..."></textarea>
                </div>
                <div class="form-group">
                    <label for="char-bloodline">Bloodline/Background</label>
                    <textarea id="char-bloodline" placeholder="Family, heritage, background..."></textarea>
                </div>
                <div class="form-group">
                    <label for="char-growth">Character Growth</label>
                    <textarea id="char-growth" placeholder="How they change throughout the story..."></textarea>
                </div>
                <div class="form-group">
                    <label for="char-quotes">Major Quotes</label>
                    <textarea id="char-quotes" placeholder="Important things they say..."></textarea>
                </div>
                <div class="form-group">
                    <label for="char-impact">Impact on Story</label>
                    <textarea id="char-impact" placeholder="How they affect the plot..."></textarea>
                </div>
                <button type="submit" class="save-btn">Save Character</button>
            </form>
        </div>
    </div>

    <!-- Plot Modal -->
    <div class="modal" id="plot-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('plot-modal')">&times;</button>
            <h2 id="plot-modal-title">Add Plot Point</h2>
            <form id="plot-form">
                <div class="form-group">
                    <label for="plot-title">Title</label>
                    <input type="text" id="plot-title" required>
                </div>
                <div class="form-group">
                    <label for="plot-type">Type</label>
                    <select id="plot-type" style="width: 100%; background: #404040; border: 1px solid #606060; color: #e0e0e0; padding: 0.5rem; border-radius: 0.25rem;">
                        <option value="major">Major Plot Point</option>
                        <option value="minor">Minor Plot Point</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="plot-parent">Parent Plot Point (for minor points)</label>
                    <select id="plot-parent" style="width: 100%; background: #404040; border: 1px solid #606060; color: #e0e0e0; padding: 0.5rem; border-radius: 0.25rem;">
                        <option value="">None (Major Plot Point)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="plot-description">Description</label>
                    <textarea id="plot-description" placeholder="Describe this plot point..."></textarea>
                </div>
                <button type="submit" class="save-btn">Save Plot Point</button>
            </form>
        </div>
    </div>

    <!-- Character Popup -->
    <div class="character-popup" id="character-popup">
        <div id="character-popup-content"></div>
    </div>

    <script>
        // Global state
        let currentTab = 'characters';
        let currentChapter = '1';
        let characters = {};
        let plotPoints = {};
        let chapterData = {};
        let annotations = {};
        let editingCharacter = null;
        let editingPlot = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
            renderCharacters();
            renderPlotPoints();
            loadChapterData();
        });

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Chapter selection
            document.getElementById('chapter-select').addEventListener('change', function() {
                saveCurrentChapterData();
                currentChapter = this.value;
                loadChapterData();
            });

            // Auto-save writing content
            document.getElementById('plot-draft').addEventListener('input', debounce(saveCurrentChapterData, 1000));
            document.getElementById('writing-area').addEventListener('input', debounce(function() {
                saveCurrentChapterData();
                processCharacterLinks();
            }, 1000));

            // Character form
            document.getElementById('character-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCharacter();
            });

            // Plot form
            document.getElementById('plot-form').addEventListener('submit', function(e) {
                e.preventDefault();
                savePlotPoint();
            });

            // Click outside character popup to close
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.character-popup') && !e.target.closest('.character-link')) {
                    hideCharacterPopup();
                }
            });

            // Text selection for annotations
            document.getElementById('writing-area').addEventListener('mouseup', handleTextSelection);
        }

        function switchTab(tabName) {
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            currentTab = tabName;
        }

        function openCharacterModal(characterId = null) {
            editingCharacter = characterId;
            const modal = document.getElementById('character-modal');
            const title = document.getElementById('character-modal-title');
            const form = document.getElementById('character-form');

            if (characterId) {
                title.textContent = 'Edit Character';
                const character = characters[characterId];
                document.getElementById('char-name').value = character.name;
                document.getElementById('char-traits').value = character.traits || '';
                document.getElementById('char-visuals').value = character.visuals || '';
                document.getElementById('char-bloodline').value = character.bloodline || '';
                document.getElementById('char-growth').value = character.growth || '';
                document.getElementById('char-quotes').value = character.quotes || '';
                document.getElementById('char-impact').value = character.impact || '';
            } else {
                title.textContent = 'Add Character';
                form.reset();
            }

            modal.classList.add('active');
        }

        function openPlotModal(plotId = null) {
            editingPlot = plotId;
            const modal = document.getElementById('plot-modal');
            const title = document.getElementById('plot-modal-title');
            const form = document.getElementById('plot-form');
            
            // Populate parent options
            const parentSelect = document.getElementById('plot-parent');
            parentSelect.innerHTML = '<option value="">None (Major Plot Point)</option>';
            Object.entries(plotPoints).forEach(([id, plot]) => {
                if (plot.type === 'major' && id !== plotId) {
                    parentSelect.innerHTML += `<option value="${id}">${plot.title}</option>`;
                }
            });

            if (plotId) {
                title.textContent = 'Edit Plot Point';
                const plot = plotPoints[plotId];
                document.getElementById('plot-title').value = plot.title;
                document.getElementById('plot-type').value = plot.type;
                document.getElementById('plot-parent').value = plot.parent || '';
                document.getElementById('plot-description').value = plot.description || '';
            } else {
                title.textContent = 'Add Plot Point';
                form.reset();
            }

            modal.classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function saveCharacter() {
            const id = editingCharacter || Date.now().toString();
            const character = {
                id: id,
                name: document.getElementById('char-name').value,
                traits: document.getElementById('char-traits').value,
                visuals: document.getElementById('char-visuals').value,
                bloodline: document.getElementById('char-bloodline').value,
                growth: document.getElementById('char-growth').value,
                quotes: document.getElementById('char-quotes').value,
                impact: document.getElementById('char-impact').value
            };

            characters[id] = character;
            saveData();
            renderCharacters();
            closeModal('character-modal');
            editingCharacter = null;
        }

        function savePlotPoint() {
            const id = editingPlot || Date.now().toString();
            const plot = {
                id: id,
                title: document.getElementById('plot-title').value,
                type: document.getElementById('plot-type').value,
                parent: document.getElementById('plot-parent').value || null,
                description: document.getElementById('plot-description').value
            };

            plotPoints[id] = plot;
            saveData();
            renderPlotPoints();
            closeModal('plot-modal');
            editingPlot = null;
        }

        function renderCharacters() {
            const container = document.getElementById('characters-list');
            container.innerHTML = '';

            Object.values(characters).forEach(character => {
                const card = document.createElement('div');
                card.className = 'character-card';
                card.onclick = () => openCharacterModal(character.id);
                
                card.innerHTML = `
                    <div class="character-name">${character.name}</div>
                    <div class="character-traits">
                        ${character.traits ? character.traits.substring(0, 100) + (character.traits.length > 100 ? '...' : '') : 'No traits defined'}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function renderPlotPoints() {
            const container = document.getElementById('plot-list');
            container.innerHTML = '';

            // Render major plot points first, then their children
            Object.values(plotPoints)
                .filter(plot => plot.type === 'major')
                .forEach(plot => {
                    renderPlotPoint(container, plot);
                    
                    // Render minor plot points under this major one
                    Object.values(plotPoints)
                        .filter(childPlot => childPlot.parent === plot.id)
                        .forEach(childPlot => {
                            renderPlotPoint(container, childPlot);
                        });
                });

            // Render orphaned minor plot points
            Object.values(plotPoints)
                .filter(plot => plot.type === 'minor' && !plot.parent)
                .forEach(plot => {
                    renderPlotPoint(container, plot);
                });
        }

        function renderPlotPoint(container, plot) {
            const card = document.createElement('div');
            card.className = `plot-point ${plot.type}`;
            card.onclick = () => openPlotModal(plot.id);
            
            card.innerHTML = `
                <div class="plot-title">${plot.title}</div>
                <div class="plot-description">
                    ${plot.description ? plot.description.substring(0, 150) + (plot.description.length > 150 ? '...' : '') : 'No description'}
                </div>
            `;
            
            container.appendChild(card);
        }

        function loadChapterData() {
            const chapterKey = `chapter_${currentChapter}`;
            const data = chapterData[chapterKey] || { plotDraft: '', content: '' };
            
            document.getElementById('plot-draft').value = data.plotDraft;
            document.getElementById('writing-area').value = data.content;
            
            processCharacterLinks();
        }

        function saveCurrentChapterData() {
            const chapterKey = `chapter_${currentChapter}`;
            chapterData[chapterKey] = {
                plotDraft: document.getElementById('plot-draft').value,
                content: document.getElementById('writing-area').value
            };
            saveData();
        }

        function processCharacterLinks() {
            const writingArea = document.getElementById('writing-area');
            let content = writingArea.value;
            
            // Reset to plain text
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            content = tempDiv.textContent || tempDiv.innerText || '';
            
            // Find character names and make them linkable
            Object.values(characters).forEach(character => {
                const regex = new RegExp(`\\b${character.name}\\b`, 'gi');
                content = content.replace(regex, `<span class="character-link" data-character-id="${character.id}">${character.name}</span>`);
            });
            
            // Note: For a full implementation, you'd want to use a rich text editor
            // For now, we'll handle this in a simplified way
        }

        function showCharacterPopup(characterId, x, y) {
            const character = characters[characterId];
            if (!character) return;
            
            const popup = document.getElementById('character-popup');
            const content = document.getElementById('character-popup-content');
            
            content.innerHTML = `
                <h3>${character.name}</h3>
                <p><strong>Traits:</strong> ${character.traits || 'None'}</p>
                <p><strong>Visual:</strong> ${character.visuals || 'None'}</p>
                <p><strong>Impact:</strong> ${character.impact || 'None'}</p>
            `;
            
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            popup.classList.add('active');
        }

        function hideCharacterPopup() {
            document.getElementById('character-popup').classList.remove('active');
        }

        function handleTextSelection() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && selection.toString().trim()) {
                const range = selection.getRangeAt(0);
                const selectedText = selection.toString().trim();
                
                // Simple annotation system - in a full app, you'd want more sophisticated handling
                if (confirm(`Add note to: "${selectedText}"?`)) {
                    const note = prompt('Enter your note:');
                    if (note) {
                        // Store annotation (simplified)
                        const annotationId = Date.now().toString();
                        annotations[annotationId] = {
                            text: selectedText,
                            note: note,
                            chapter: currentChapter
                        };
                        saveData();
                    }
                }
            }
        }

        function saveData() {
            const data = {
                characters: characters,
                plotPoints: plotPoints,
                chapterData: chapterData,
                annotations: annotations
            };
            
            try {
                const dataString = JSON.stringify(data);
                if (dataString.length > 5 * 1024 * 1024) { // 5MB limit
                    alert('Data is getting large. Consider exporting and starting fresh.');
                    return;
                }
                window.localStorage.setItem('novelWriterData', dataString);
            } catch (e) {
                console.error('Failed to save data:', e);
                alert('Failed to save data. Storage might be full.');
            }
        }

        function loadData() {
            try {
                const data = JSON.parse(window.localStorage.getItem('novelWriterData') || '{}');
                characters = data.characters || {};
                plotPoints = data.plotPoints || {};
                chapterData = data.chapterData || {};
                annotations = data.annotations || {};
            } catch (e) {
                console.error('Failed to load data:', e);
                characters = {};
                plotPoints = {};
                chapterData = {};
                annotations = {};
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Word count functionality
        function updateWordCount() {
            const content = document.getElementById('writing-area').value;
            const wordCount = content.trim() ? content.trim().split(/\s+/).length : 0;
            
            let wordCountElement = document.getElementById('word-count');
            if (!wordCountElement) {
                wordCountElement = document.createElement('div');
                wordCountElement.id = 'word-count';
                wordCountElement.style.cssText = `
                    position: absolute;
                    bottom: 1rem;
                    right: 1rem;
                    background: rgba(42, 42, 42, 0.9);
                    padding: 0.5rem;
                    border-radius: 0.25rem;
                    font-size: 0.8rem;
                    color: #a0a0a0;
                    pointer-events: none;
                    z-index: 5;
                `;
                document.querySelector('.writing-pane').appendChild(wordCountElement);
            }
            
            wordCountElement.textContent = `${wordCount} words`;
        }

        // Enhanced character detection and linking
        function processCharacterLinks() {
            // This runs after text changes to detect character names
            const writingArea = document.getElementById('writing-area');
            const content = writingArea.value;
            
            // Simple detection - in a full app you'd use a rich text editor
            writingArea.addEventListener('click', function(e) {
                const cursorPos = writingArea.selectionStart;
                const words = content.split(/\s+/);
                let charPos = 0;
                
                for (let word of words) {
                    if (cursorPos >= charPos && cursorPos <= charPos + word.length) {
                        const cleanWord = word.replace(/[.,!?;:"()]/g, '');
                        const foundCharacter = Object.values(characters).find(
                            char => char.name.toLowerCase() === cleanWord.toLowerCase()
                        );
                        
                        if (foundCharacter) {
                            showCharacterPopup(foundCharacter.id, e.clientX, e.clientY);
                            break;
                        }
                    }
                    charPos += word.length + 1;
                }
            });
        }

        // Enhanced text selection for annotations
        function handleTextSelection() {
            const selection = window.getSelection();
            const writingArea = document.getElementById('writing-area');
            
            if (selection.rangeCount > 0 && selection.toString().trim() && 
                writingArea.contains(selection.anchorNode)) {
                
                const selectedText = selection.toString().trim();
                
                if (confirm(`Add note to: "${selectedText.length > 30 ? selectedText.substring(0, 30) + '...' : selectedText}"?`)) {
                    const note = prompt('Enter your note:');
                    if (note && note.trim()) {
                        createAnnotation(selectedText, note.trim());
                        selection.removeAllRanges();
                    }
                }
            }
        }

        // Annotation system
        function createAnnotation(selectedText, note) {
            const annotationId = Date.now().toString();
            const chapterKey = `chapter_${currentChapter}`;
            
            if (!annotations[chapterKey]) {
                annotations[chapterKey] = {};
            }
            
            annotations[chapterKey][annotationId] = {
                id: annotationId,
                text: selectedText,
                note: note,
                timestamp: new Date().toISOString()
            };
            
            saveData();
            renderAnnotations();
        }

        function renderAnnotations() {
            const chapterKey = `chapter_${currentChapter}`;
            const chapterAnnotations = annotations[chapterKey] || {};
            const noteContent = document.getElementById('note-content');
            
            if (Object.keys(chapterAnnotations).length > 0) {
                let notesHtml = '';
                Object.values(chapterAnnotations).forEach(annotation => {
                    notesHtml += `
                        <div style="margin-bottom: 1rem; padding: 0.5rem; background: #404040; border-radius: 0.25rem;">
                            <div style="font-weight: bold; margin-bottom: 0.25rem; color: #60a5fa;">
                                "${annotation.text}"
                            </div>
                            <div style="font-size: 0.9rem; color: #e0e0e0;">
                                ${annotation.note}
                            </div>
                            <button onclick="deleteAnnotation('${annotation.id}')" 
                                    style="margin-top: 0.5rem; background: #ef4444; border: none; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem;">
                                Delete
                            </button>
                        </div>
                    `;
                });
                noteContent.innerHTML = notesHtml;
                document.getElementById('notes-panel').style.display = 'block';
            } else {
                noteContent.innerHTML = '<p style="color: #a0a0a0; font-style: italic;">No notes for this chapter yet.</p>';
            }
        }

        function deleteAnnotation(annotationId) {
            const chapterKey = `chapter_${currentChapter}`;
            if (annotations[chapterKey] && annotations[chapterKey][annotationId]) {
                delete annotations[chapterKey][annotationId];
                saveData();
                renderAnnotations();
            }
        }

        // Search functionality
        function addSearchButton() {
            const header = document.querySelector('.header');
            const searchBtn = document.createElement('button');
            searchBtn.innerHTML = '🔍';
            searchBtn.style.cssText = `
                background: #404040;
                border: none;
                color: #e0e0e0;
                padding: 0.5rem;
                border-radius: 0.25rem;
                cursor: pointer;
                font-size: 1rem;
                margin-left: 1rem;
            `;
            searchBtn.onclick = openSearchModal;
            header.appendChild(searchBtn);
        }

        function openSearchModal() {
            const searchModal = document.createElement('div');
            searchModal.className = 'modal active';
            searchModal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    <h2>Search</h2>
                    <div class="form-group">
                        <label>Search in:</label>
                        <select id="search-scope" style="width: 100%; background: #404040; border: 1px solid #606060; color: #e0e0e0; padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 1rem;">
                            <option value="all">All Content</option>
                            <option value="characters">Characters</option>
                            <option value="plot">Plot Points</option>
                            <option value="writing">Writing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="text" id="search-input" placeholder="Search..." style="width: 100%; background: #404040; border: 1px solid #606060; color: #e0e0e0; padding: 0.5rem; border-radius: 0.25rem;">
                    </div>
                    <div id="search-results" style="max-height: 300px; overflow-y: auto; margin-top: 1rem;"></div>
                </div>
            `;
            
            document.body.appendChild(searchModal);
            
            const searchInput = searchModal.querySelector('#search-input');
            searchInput.addEventListener('input', debounce(performSearch, 300));
            searchInput.focus();
        }

        function performSearch() {
            const query = document.getElementById('search-input')?.value?.toLowerCase()?.trim();
            const scope = document.getElementById('search-scope')?.value;
            const resultsDiv = document.getElementById('search-results');
            
            if (!query || !resultsDiv) {
                if (resultsDiv) resultsDiv.innerHTML = '';
                return;
            }
            
            let results = [];
            
            // Search characters
            if (scope === 'all' || scope === 'characters') {
                Object.values(characters).forEach(character => {
                    const searchableText = `${character.name} ${character.traits || ''} ${character.visuals || ''} ${character.bloodline || ''} ${character.growth || ''} ${character.quotes || ''} ${character.impact || ''}`.toLowerCase();
                    if (searchableText.includes(query)) {
                        results.push({
                            type: 'Character',
                            title: character.name,
                            content: character.traits || 'No description',
                            action: `switchTab('characters'); openCharacterModal('${character.id}');`
                        });
                    }
                });
            }
            
            // Search plot points
            if (scope === 'all' || scope === 'plot') {
                Object.values(plotPoints).forEach(plot => {
                    const searchableText = `${plot.title} ${plot.description || ''}`.toLowerCase();
                    if (searchableText.includes(query)) {
                        results.push({
                            type: 'Plot Point',
                            title: plot.title,
                            content: plot.description || 'No description',
                            action: `switchTab('plot'); openPlotModal('${plot.id}');`
                        });
                    }
                });
            }
            
            // Search writing content
            if (scope === 'all' || scope === 'writing') {
                Object.entries(chapterData).forEach(([chapterKey, data]) => {
                    const chapterNum = chapterKey.replace('chapter_', '');
                    const searchableText = `${data.plotDraft || ''} ${data.content || ''}`.toLowerCase();
                    if (searchableText.includes(query)) {
                        results.push({
                            type: 'Chapter',
                            title: `Chapter ${chapterNum}`,
                            content: data.content ? data.content.substring(0, 100) + '...' : 'No content',
                            action: `switchTab('writing'); document.getElementById('chapter-select').value = '${chapterNum}'; currentChapter = '${chapterNum}'; loadChapterData();`
                        });
                    }
                });
            }
            
            // Display results
            if (results.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #a0a0a0; font-style: italic;">No results found</p>';
            } else {
                resultsDiv.innerHTML = results.map(result => `
                    <div style="background: #404040; padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.25rem; cursor: pointer;" 
                         onclick="this.closest('.modal').remove(); ${result.action}">
                        <div style="font-weight: bold; color: #60a5fa;">${result.type}: ${result.title}</div>
                        <div style="font-size: 0.9rem; color: #a0a0a0; margin-top: 0.25rem;">
                            ${result.content}
                        </div>
                    </div>
                `).join('');
            }
        }

        // Statistics functionality
        function addStatsButton() {
            const header = document.querySelector('.header');
            const statsBtn = document.createElement('button');
            statsBtn.innerHTML = '📊';
            statsBtn.style.cssText = `
                background: #404040;
                border: none;
                color: #e0e0e0;
                padding: 0.5rem;
                border-radius: 0.25rem;
                cursor: pointer;
                font-size: 1rem;
                margin-left: 0.5rem;
            `;
            statsBtn.onclick = showStatistics;
            header.appendChild(statsBtn);
        }

        function showStatistics() {
            const totalCharacters = Object.keys(characters).length;
            const totalPlotPoints = Object.keys(plotPoints).length;
            
            let totalWords = 0;
            let chaptersWithContent = 0;
            
            Object.values(chapterData).forEach(chapter => {
                if (chapter.content && chapter.content.trim()) {
                    chaptersWithContent++;
                    totalWords += chapter.content.trim().split(/\s+/).length;
                }
            });
            
            const statsModal = document.createElement('div');
            statsModal.className = 'modal active';
            statsModal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    <h2>Writing Statistics</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                        <div style="background: #404040; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #60a5fa;">${totalWords}</div>
                            <div style="color: #a0a0a0;">Total Words</div>
                        </div>
                        <div style="background: #404040; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #22c55e;">${chaptersWithContent}</div>
                            <div style="color: #a0a0a0;">Chapters Written</div>
                        </div>
                        <div style="background: #404040; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">${totalCharacters}</div>
                            <div style="color: #a0a0a0;">Characters</div>
                        </div>
                        <div style="background: #404040; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #ef4444;">${totalPlotPoints}</div>
                            <div style="color: #a0a0a0;">Plot Points</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; text-align: center;">
                        <button onclick="exportData()" style="background: #60a5fa; border: none; color: white; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; margin-right: 0.5rem;">
                            Export Data
                        </button>
                        <label for="import-file-${Date.now()}" style="background: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer;">
                            Import Data
                        </label>
                        <input type="file" id="import-file-${Date.now()}" accept=".json" style="display: none;" onchange="importData(event)">
                    </div>
                </div>
            `;
            
            document.body.appendChild(statsModal);
        }

        // Export and import functions
        function exportData() {
            const data = {
                characters: characters,
                plotPoints: plotPoints,
                chapterData: chapterData,
                annotations: annotations,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `novel-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm('This will overwrite all current data. Continue?')) {
                        characters = data.characters || {};
                        plotPoints = data.plotPoints || {};
                        chapterData = data.chapterData || {};
                        annotations = data.annotations || {};
                        saveData();
                        renderCharacters();
                        renderPlotPoints();
                        loadChapterData();
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Invalid file format');
                }
            };
            reader.readAsText(file);
        }

        // Initialize extra features when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add word count updates
            const writingArea = document.getElementById('writing-area');
            if (writingArea) {
                writingArea.addEventListener('input', debounce(updateWordCount, 500));
                updateWordCount();
            }
            
            // Add extra buttons
            setTimeout(() => {
                addSearchButton();
                addStatsButton();
                processCharacterLinks();
                renderAnnotations();
            }, 100);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveCurrentChapterData();
                
                // Visual feedback
                const header = document.querySelector('.header h1');
                const originalText = header.textContent;
                header.textContent = 'Saved!';
                header.style.color = '#22c55e';
                setTimeout(() => {
                    header.textContent = originalText;
                    header.style.color = '#60a5fa';
                }, 1000);
            }
            
            // Ctrl/Cmd + 1-3 for tab switching
            if ((e.ctrlKey || e.metaKey) && ['1', '2', '3'].includes(e.key)) {
                e.preventDefault();
                const tabs = ['characters', 'plot', 'writing'];
                switchTab(tabs[parseInt(e.key) - 1]);
            }
        });

    </script>
</body>
</html>
